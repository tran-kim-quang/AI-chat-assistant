<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI CSV Analyzer - Phân tích CSV thông minh</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container-main {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px;
        }
        
        .header {
            text-align: center;
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
            font-weight: bold;
        }
        
        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .upload-zone:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }
        
        .upload-zone i {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 10px 30px;
            border-radius: 25px;
            font-weight: bold;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .quick-action-btn {
            margin: 5px;
            border-radius: 20px;
        }
        
        .result-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .table {
            font-size: 0.9rem;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .alert {
            border-radius: 10px;
        }
        
        #preview {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-main">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> AI CSV Analyzer</h1>
            <p class="lead">Phân tích dữ liệu CSV thông minh với AI</p>
        </div>

        <!-- Upload Section -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-upload"></i> Tải lên CSV
            </div>
            <div class="card-body">
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" id="uploadTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-upload" type="button">
                            <i class="fas fa-file-upload"></i> Upload File
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url-upload" type="button">
                            <i class="fas fa-link"></i> URL (GitHub)
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="uploadTabContent">
                    <!-- File Upload -->
                    <div class="tab-pane fade show active" id="file-upload">
                        <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h5>Kéo thả file CSV vào đây</h5>
                            <p class="text-muted">hoặc click để chọn file (tối đa 10MB)</p>
                            <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="uploadFile()">
                        </div>
                    </div>

                    <!-- URL Upload -->
                    <div class="tab-pane fade" id="url-upload">
                        <div class="input-group">
                            <input type="text" class="form-control" id="csvUrl" placeholder="Nhập URL CSV (vd: https://raw.githubusercontent.com/...)">
                            <button class="btn btn-primary" onclick="loadFromURL()">
                                <i class="fas fa-download"></i> Tải từ URL
                            </button>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> Hỗ trợ GitHub raw CSV links và URLs công khai
                        </small>
                    </div>
                </div>

                <!-- Preview -->
                <div id="preview" class="mt-4" style="display: none;">
                    <h5><i class="fas fa-eye"></i> Xem trước dữ liệu:</h5>
                    <div id="previewContent"></div>
                </div>
            </div>
        </div>

        <!-- Analysis Section -->
        <div class="card" id="analysisSection" style="display: none;">
            <div class="card-header">
                <i class="fas fa-analytics"></i> Phân tích dữ liệu
            </div>
            <div class="card-body">
                <!-- Quick Actions -->
                <div class="mb-3">
                    <h6>Phân tích nhanh:</h6>
                    <button class="btn btn-outline-primary quick-action-btn" onclick="quickAnalysis('summarize')">
                        <i class="fas fa-list"></i> Tóm tắt Dataset
                    </button>
                    <button class="btn btn-outline-success quick-action-btn" onclick="quickAnalysis('stats')">
                        <i class="fas fa-chart-bar"></i> Thống kê cơ bản
                    </button>
                    <button class="btn btn-outline-warning quick-action-btn" onclick="quickAnalysis('missing')">
                        <i class="fas fa-question-circle"></i> Missing Values
                    </button>
                    <button class="btn btn-outline-info quick-action-btn" onclick="showHistogramDialog()">
                        <i class="fas fa-chart-column"></i> Histogram
                    </button>
                </div>

                <!-- Custom Question -->
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="customQuestion" placeholder="Đặt câu hỏi về dữ liệu (vd: Ai có lương cao nhất?)">
                    <button class="btn btn-primary" onclick="askQuestion()">
                        <i class="fas fa-paper-plane"></i> Hỏi AI
                    </button>
                </div>

                <!-- Results -->
                <div id="results" style="display: none;">
                    <h6><i class="fas fa-lightbulb"></i> Kết quả:</h6>
                    <div class="result-container" id="resultContent"></div>
                </div>

                <!-- Clear Button -->
                <div class="text-end mt-3">
                    <button class="btn btn-outline-danger" onclick="clearData()">
                        <i class="fas fa-trash"></i> Xóa và tải lại
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" style="display: none; text-align: center; padding: 50px;">
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Đang xử lý...</span>
            </div>
            <p class="text-white mt-3">Đang xử lý...</p>
        </div>

        <!-- Alerts -->
        <div id="alertContainer"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script>
        // Upload file
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            showLoading();
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showAlert('danger', data.error);
                } else {
                    showPreview(data.preview, data.summary);
                    showAnalysisSection();
                    showAlert('success', `File "${data.filename}" đã được tải lên thành công!`);
                }
            } catch (error) {
                showAlert('danger', 'Lỗi khi upload file: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Load from URL
        async function loadFromURL() {
            const url = document.getElementById('csvUrl').value;
            
            if (!url) {
                showAlert('warning', 'Vui lòng nhập URL');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch('/load_url', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({url})
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showAlert('danger', data.error);
                } else {
                    showPreview(data.preview, data.summary);
                    showAnalysisSection();
                    showAlert('success', 'CSV đã được tải từ URL thành công!');
                }
            } catch (error) {
                showAlert('danger', 'Lỗi khi tải URL: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Quick analysis
        async function quickAnalysis(type) {
            showLoading();
            
            try {
                const body = type === 'histogram' ? 
                    JSON.stringify({column: await selectColumn()}) : null;
                
                const response = await fetch(`/quick_analysis/${type}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: body
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showAlert('danger', data.error);
                } else {
                    showResult(data.result);
                }
            } catch (error) {
                showAlert('danger', 'Lỗi phân tích: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Ask custom question
        async function askQuestion() {
            const question = document.getElementById('customQuestion').value;
            
            if (!question) {
                showAlert('warning', 'Vui lòng nhập câu hỏi');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({question})
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showAlert('danger', data.error);
                } else {
                    showResult(data.result);
                }
            } catch (error) {
                showAlert('danger', 'Lỗi: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Show histogram dialog
        async function showHistogramDialog() {
            try {
                const response = await fetch('/get_columns');
                const columns = await response.json();
                
                if (columns.numeric.length === 0) {
                    showAlert('warning', 'Dataset không có cột số');
                    return;
                }
                
                const column = prompt('Chọn cột để vẽ histogram:\n' + columns.numeric.join(', '));
                
                if (column && columns.numeric.includes(column)) {
                    showLoading();
                    const resp = await fetch('/quick_analysis/histogram', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({column})
                    });
                    
                    const data = await resp.json();
                    hideLoading();
                    
                    if (data.error) {
                        showAlert('danger', data.error);
                    } else {
                        showResult(data.result);
                    }
                }
            } catch (error) {
                hideLoading();
                showAlert('danger', 'Lỗi: ' + error.message);
            }
        }

        // Clear data
        async function clearData() {
            if (confirm('Bạn có chắc muốn xóa dữ liệu và bắt đầu lại?')) {
                await fetch('/clear', {method: 'POST'});
                location.reload();
            }
        }

        // UI helpers
        function showPreview(html, summary) {
            document.getElementById('previewContent').innerHTML = html + '<pre class="mt-3">' + summary + '</pre>';
            document.getElementById('preview').style.display = 'block';
        }

        function showAnalysisSection() {
            document.getElementById('analysisSection').style.display = 'block';
        }

        function showResult(text) {
            document.getElementById('resultContent').textContent = text;
            document.getElementById('results').style.display = 'block';
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById('alertContainer').innerHTML = alertHtml;
            
            setTimeout(() => {
                document.getElementById('alertContainer').innerHTML = '';
            }, 5000);
        }

        // Allow enter key to submit question
        document.getElementById('customQuestion')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') askQuestion();
        });
    </script>
</body>
</html>

